<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RNA-seq Analysis Platform</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üß¨ RNA-seq Analysis Platform</h1>
            <p>Upload FASTQ files for automated analysis</p>
        </header>

        <nav>
            <a href="index.html" class="active">Upload</a>
            <a href="status.html">Check Status</a>
            <a href="results.html">Results</a>
        </nav>

        <main>
            <div class="upload-section">
                <h2>Upload FASTQ Files</h2>
                
                <form id="uploadForm">
                    <div class="form-group">
                        <label for="userEmail">Your Email (for notifications)</label>
                        <input type="email" id="userEmail" required 
                               placeholder="your.email@example.com">
                        <small>We'll send you a notification when analysis is complete</small>
                    </div>

                    <div class="form-group">
                        <label for="fileInput">Select FASTQ Files (.fq.gz)</label>
                        <input type="file" id="fileInput" multiple accept=".fq.gz,.fastq.gz" required>
                        <small>Select multiple .fq.gz files (up to 5GB total)</small>
                    </div>

                    <div id="fileList" class="file-list"></div>

                    <button type="submit" id="uploadBtn" class="btn-primary">
                        Upload & Start Analysis
                    </button>
                </form>

                <div id="uploadProgress" class="progress-section" style="display: none;">
                    <h3>Upload Progress</h3>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <p id="progressText">Preparing upload...</p>
                    <p id="fileProgress"></p>
                </div>

                <div id="uploadResult" class="result-section" style="display: none;">
                    <h3>‚úì Upload Successful!</h3>
                    <p>Your job has been submitted for analysis.</p>
                    <div class="job-info">
                        <strong>Job ID:</strong> <span id="jobId"></span>
                        <button onclick="copyJobId()" class="btn-small">Copy</button>
                    </div>
                    <p class="info">
                        Save this Job ID to check status and retrieve results later.
                        We'll also send it to your email.
                    </p>
                    <div class="actions">
                        <a href="status.html" class="btn-secondary">Check Status</a>
                        <button onclick="location.reload()" class="btn-secondary">Upload More</button>
                    </div>
                </div>

                <div id="uploadError" class="error-section" style="display: none;">
                    <h3>‚ùå Upload Failed</h3>
                    <p id="errorMessage"></p>
                    <button onclick="location.reload()" class="btn-secondary">Try Again</button>
                </div>
            </div>

            <div class="info-section">
                <h3>üìã Requirements</h3>
                <ul>
                    <li>Files must be in .fq.gz or .fastq.gz format</li>
                    <li>Maximum 20 files per job</li>
                    <li>Total size up to 5GB</li>
                    <li>Processing time: 1-3 hours depending on file size</li>
                </ul>

                <h3>üìä What You'll Get</h3>
                <ul>
                    <li>Quality control reports (FastQC, MultiQC)</li>
                    <li>Normalized gene expression data</li>
                    <li>Machine learning predictions</li>
                    <li>PCA visualization plots</li>
                    <li>Comprehensive analysis summary</li>
                </ul>

                <h3>‚öôÔ∏è Pipeline Steps</h3>
                <ol>
                    <li>Quality control (FastQC)</li>
                    <li>Read trimming (fastp)</li>
                    <li>Alignment (HISAT2)</li>
                    <li>Gene counting (featureCounts)</li>
                    <li>Normalization (DESeq2)</li>
                    <li>ML prediction (XGBoost)</li>
                </ol>
            </div>
        </main>

        <footer>
            <p>RNA-seq Analysis Platform ‚Ä¢ Free & Open Source ‚Ä¢ 
               <a href="https://github.com/yourusername/rnaseq-analysis" target="_blank">GitHub</a>
            </p>
        </footer>
    </div>

    <script src="config.js"></script>
    <script src="app.js"></script>
    <script>
        // File selection handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            const files = Array.from(e.target.files);
            
            if (files.length === 0) return;
            
            let totalSize = 0;
            const fileItems = document.createElement('div');
            
            files.forEach(file => {
                totalSize += file.size;
                
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                `;
                fileItems.appendChild(item);
            });
            
            const summary = document.createElement('div');
            summary.className = 'file-summary';
            summary.innerHTML = `
                <strong>Total:</strong> ${files.length} files, ${formatFileSize(totalSize)}
            `;
            
            fileList.appendChild(fileItems);
            fileList.appendChild(summary);
            
            // Validation
            if (files.length > 20) {
                alert('Maximum 20 files allowed. Please select fewer files.');
                e.target.value = '';
                fileList.innerHTML = '';
                return;
            }
            
            if (totalSize > 5 * 1024 * 1024 * 1024) {
                alert('Total size exceeds 5GB. Please select smaller files.');
                e.target.value = '';
                fileList.innerHTML = '';
                return;
            }
        });

        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('userEmail').value;
            const files = document.getElementById('fileInput').files;
            
            if (files.length === 0) {
                alert('Please select at least one file');
                return;
            }
            
            // Hide form, show progress
            document.getElementById('uploadForm').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'block';
            
            try {
                const jobId = await uploadFiles(files, email, updateProgress);
                
                // Show success
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadResult').style.display = 'block';
                document.getElementById('jobId').textContent = jobId;
                
            } catch (error) {
                // Show error
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadError').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
            }
        });

        function updateProgress(percent, text, fileText) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
            if (fileText) {
                document.getElementById('fileProgress').textContent = fileText;
            }
        }

        function copyJobId() {
            const jobId = document.getElementById('jobId').textContent;
            navigator.clipboard.writeText(jobId).then(() => {
                alert('Job ID copied to clipboard!');
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>
